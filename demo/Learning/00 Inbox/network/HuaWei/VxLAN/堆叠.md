建议:华为接入可以做堆叠,核心和汇聚做mlag
## 什么是堆叠
### 本质:横向设备的虚拟化技术
	说白来就是同一层面的虚拟化技术不存在上下级关系
### 特点

#### 将多个设备相当于虚拟化成了一台,方便了管理
#### 管理、控制、转发平面合一，共享信息实时同步
这样最起码在转发层面上实现了多活（最起码双活），同时进行数据转发

管控 ： 是主备的模式
转发 ： 是双活的模式

#### 堆叠的价值
1.  简化了运维
2.  可靠性高
3.  无环网络
.  链路负载均衡 （进行了lag（etrunk））

#### 堆叠的分类
1.  框式堆叠（CSS： cluster switch system） ： CE 12800/16800 设备
2.  盒式堆叠 (istack: intelligent stack ) : s57xx(考试主要考这个)

---
##### 框式堆叠(CSS cluster switch system)
1.  常用术语和连接方式
	1.  堆叠域id :domain id (表示横向的虚拟画设备)
	2.  堆叠成员: 最多两个成员(默认成员id0),用于表示domain 中的设备
		1.  一般情况下堆叠成员分为单成员和多成员
			1.  单成员 : 堆叠域中只有一个成员
			2.  多成员 : 堆叠域中有多个成员
				1. istack(intelligent stack) 最多16个
				2. css(Cluster switch system)最多两个
				*多成员会进行选举master和standy,选举条件5种*,**不抢占**
				多成员的选举,standy切换master立马切换,但是master切换成standy必须要进行重启(例如加入了更好的一个成员)
2.  堆叠的链接方式
- 一般对剑堆叠主控板SIP 业务板转发连线,DAD连线配置齐全,一般都是三种线缆互联
	1.  主控板直连(推荐)
		-  mpu(主操作单元),主控板一般两款,mpu1和mpu2作为一主一备
		-  SIP(system inter port) 专门用来堆叠链接的口,一般用来控制和同步 可以扩展光电模块
		-  ETH口 (可以进行ssh链接的口)
		-  ![[堆叠示意图.png]]
		-  同一个ce设备的mpu1和2通过背板相连
		-  假设左边的比较好那么A的mpu1成为master,B的mpu2成为standy,而A的mpu2叫做从1,B的mpu2叫做从2
- 主要作用是:  设备管理,路由\arp同步\css状态同步\配置同步
	1.  业务板直连(现在很少见了,无须SIP口但是业务和控制混合了)
		1.  通过业务线缆链接 LPU
![[业务板链接方式.png]]
上面的链接方式是N:N好为甚么?
	因为如果A的LPU1死掉了,N:N还有和A链接的设备
- 数据转发,mac地址同步
	**防止分裂还存在一个DAD线缆**
		*DAD检测*

## 注意主备的切换一定跨框,但是对于数据来说本地优先

## 堆叠的建立过程
首先会发送竞争报文,进行选举
1.  选举的原则
	1.  运行状态 : 先启动的的优先
	2.  堆叠的优先级 越大越优先
	3.  优选软件版本高的一般版本都是相同的
	4.  优选主控板mpu多的
	5.  设备mac地址小的
2.   堆叠建立之后会进行配置同步
	1.  板本同步
	2.  配置同步
~~3.  数据转发~~
3.  堆叠的生命周期
	1.  建立 (组件)  如果domain存在就加入,不存在就根据之前的五种选举master和standy
			运行状态 : 先启动的的优先
			堆叠优先级
			软件版本
			mpu多的
			mac地址小的
	2.  合并 连个domain合并
	3.  加入 设备加入
	4.  离开 有设备离开
	5.  切换 (主备切换) 没多大用处
	6.  分裂[[堆叠^堆叠分裂]]
		1.  主备设备之间的控制m线中断(分裂检测出两个设备并且完全一样)
		2.  拆除(解除堆叠域)
### 堆叠分裂

###### MAD和dad是一个东西(配置叫做MAD),H3C里是这样,华为的s系列存在用于多组检测(intelligent stack)
##### 堆叠分裂问题
堆叠示意图
![[堆叠分裂示意图.png]]
 1.  导致IP和mac地址冲突
	 *因为即使分裂domain还是存在,domain会使用主master的ip和mac*
##### 避免方法
DAD: dual-active detection 双主检测(intelligent stack叫做MAD检测)
功能:
双主检测:
###### 检测
第一种检测方式:业务口直连检测(占用业务口)不用配置ip借助bpdu检测传递DAD的竞争报文
![[Pasted image 20240416110645.png]]
优点:简单
缺点:占用额外端口
实际上专门拿出接口连接跑dad

第二种 Eth-trunk 代理检测
Eth-trunk可以同时跑DAD和业务
优点:不需要额外端口
缺点:需要代理设备支持
在已有的业务口运行

第三种通过网关接口来进行双主检测(不是console接口,MGP或者说E口)
通过管理网或者网关接口直连
优点:不需要额外接口和代理功能支持
缺点:走了网络管理网络,速度会慢
业务和管理分离的情况,在链接管理的配置

第四种 堆叠链路双主检测
这种检测方式只能够在通过主控板直连的接口才能够配置

###### 最好情况四种全部配置

##### 故障处理和恢复
当发生分裂的时候双主通过DAD链路互相发送dad竞争报文如果本地记录生出不做任何处理
不同堆叠建立的五中机制(运行状态,优先级大的好,软件版本,mpu多的,mac小的),dual-active detection 检测只进行优先级和mac

**竞选成功的端口不会进行任何操作,竞选失败的会进入端口进入error-down,交换机进入recover状态,不转发数据**

***恢复***
一旦链路故障恢复,竞选失败的交换机检测链路恢复,会自动重叠域,error-down接口恢复

**特殊场景**
之前竞选成功的交换机结果突然死机了,这时候需要将recover恢复
将坏掉的交换机线缆拔下(就是一处域,拔线删配置,不敢删稳妥关机,在拔线,直接拔线有一定风险),进入system-view 后输入dual-active recover将error-down接口恢复(但是这样做之后坏的交换机恢复上线有可能竞选不会再是master) 
**无转发链路或者接口和板卡故障直接输,不会竞选**

---
上面讲解的是主控链路故障,如果是lag故障则直接进入error-down状态

保留端口缺省情况下堆叠端口被设置为保留端口
dual-active excude

## 堆叠的问题
堆叠的故障域大,会波及全部,mlag则是多个故障域

### lag 就是link-aggregate 
mlag 考试不考,但是显示中用的很多所以还需要了解

## 堆叠卡的好处
堆叠卡的好处,堆叠卡直接背板链接,不通过显卡,没有线卡限制
但是随着发展,目前线卡已经很接近备卡了
# 重要
实际工作中 最多的是版本管理,现实的问题多少软件问题,流程问题

---
# intelligent stack 堆叠
	最多支持16台构建堆叠,并且没有专用的m管理线缆.只有业务线缆堆叠他管控共线

css(cluster switch system)中相同的这里省略了

堆叠设备中会选择出主备从
主设备选择出之后给成员分配成员id
堆叠id不配置自动分配会乱,所以建议提前配置好
标识默认1~8
**根据之前的记忆这里应该是0默认配置不了只有四绑定的时候可能出现**

### 堆叠方式
链式链接
优点:长距离
缺点: 可靠性差,一旦断了没有冗余分裂
环形链接(建议)
优点:可靠性高
缺点: 成本高,不适合长举例

### 建立方式
通cluster switch system
先启动
优先级
软件版本
mpu(盒式没有)
mac地址小的

### 加入退出
新设备加入直接成为从

两个堆叠系统合并会进行选举,选举失败的会全部变为slave造成中断重新分配成员id同步检测

### 多主检测
MAD(multi active detection) 多主检测
CSS 叫做DAD(dual-active detection)双主检测因为他只有两个
#### 检测方式(20s之内默认相同)
1.  直连方式(业务线缆)
	1.  直接互联 (full mesh) 全互联成本高
	2.  通过交换机互联,可靠性低,依赖第三方交换机并且成为了故障点
2.  代理方式(不用占用额外接口)
	1.  设备需要支持 
     可以通过单机代理,或者堆叠系统代理
     通过bpdu发送报文
3. 分裂系统分为detect 和recover
	1. detect 正常
	2.  recover 不会转发
	- 优先先启动的为detect
	- 如果20s之内比较mac地址小的
    3.  恢复
	    1.  堆叠线缆恢复处于recover的交换机会重启加入
   - 分裂之后会以1s为周期发送检测,css中是m线断,istack是stack的port 端口故障
**同样原先的detect故障也是需要进行拔线进入系统视图配置detect-active recover**

### istack的配置
![[堆叠配置图例.png]]
控制重启以便选择master和salve交换机
配置主交换机stack
设备1(主交换机)
interface stack-port 创建堆叠端口
 port interface xg 0/1 enable
 shutdown interface xg 0/0/1 *一定要*
stack slot 0 prity 150
 interface stack-port 0/2
 port interface 0/0/2 enable
 shutdown 
 stack slot 0 priority 配置端口优先级
 设备二 
 interface stack 0/1 
 port xg 0/0/2 enable
 shutdown 
 interface stack-port 0/2
 port interface xg 0/0/1 
 stack slot 0 renumber 1 配置成员id **这个船员id关联端口前缀**
将主交换机的接口interface stack undo掉之前的shutdown
 display stack configuration
重置设置
reset netconf db

display stack 查看stack信息
display devices 查看端口详情包括了风扇
dis stack port brief
dis stack port
stack led enable 面板等颜色显示
堆叠id除0之外只有堆叠的端口量0支持几台设备亮几台

reset stack configgutation 重置stack的所有配置

## **个人的总结,对于堆叠来讲实际上在控制层面并不是双活而是主备的情况,等到后面mLAG解决了这个问题**