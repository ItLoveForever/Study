## 什么是wan

### wan的基本组成
wan:wide area network顾名思义是广域区域网络的意思
其中广域网络的骨干网络由各运营商构建:电信、联通、移动一样
core igp：
bgp ：通常结合ipv4，evpn，vpnv4等使用
mpls： sr、srv6
广域网和广域网络之间的通过ethernet的链路传，
区别不同的wan的可以使用三层vpn或者gre
### general routing encapsulation
普通的gre是点对点的
interface tunnel 0/0/0
tunnel-protocol gre 
ip address 配置这个端口的地址
source 设置这个隧道从哪个端口发送
destination 设置这个隧道到达的目的地
同样在对应的路由器上也进行这样的配置
只是这样配置没办法走隧道
需要配置通告隧道的路径的地址
#### 静态配置gre的地址
ip route-static 10.1.2.2 tunnel 0/0/0
表示到达10.1.2.2的这个路由会走0/0/0这个隧道

```huawei
## 静态
# cpre ip
int g 0/0/0
ip address 1.1.1.1 24
int loopback 0 
ip address 10.1.1.1 32
tunnel-protocol gre 
	~~在华三中配置遂道类型general route ensulation~~
	int tunnel 0 mode gre
int tunnel 0/0/0
ip address 172.16.1.1 24 # 注意这里配置24位如果配置32会导致ospf因为网段不同建立不起ospf邻居

source 1.1.1.1 # 这个地址是传输地址，路由器连接地址
destination 1.1.1.2 # 这个地址是传输地址，路由器连接地址
ip adress 0.0.0.0 0 tunnel # 但这里可以不置默认路由，直接写想用的路由
---
# 注意遂道是两个直接连接设备间的通道
# 这里只配置R1，r2
r2
int g 0/0/0
ip address 1.1.1.2 24
int loopback 0 
ip address 10.1.2.2 32
tunnel-protocol gre 
	~~在华三中配置遂道类型general route ensulation~~
	int tunnel 0 mode gre
int tunnel 0/0/0
ip address 172.16.1.2 24 # 注意这里配置24位如果配置32会导致ospf因为网段不同建立不起ospf邻居

# 遂道配置完但是没有路由
ip adress 0.0.0.0 0 tunnel # 但这里可以不置默认路由，直接写想用的路由

```
#### 动态配置gre的地址
运行ospf将速到的ip宣告进来就可以

**这样配置存在一个很大的问题，就是ip是固定的**

解决这个出现的是MGRE，dsvpn（dynamic smart vpn）
### mgre 分为两部分一部分是
普通的gre存在一个问题，如果是hub类型，之前的配置都是已知隧道的具体源目地址,但如果我们需要建立是隧道的设备他的接口ip通过dhcp获得,会变化,这中情况,就是需要mgre(multiy general route encapsulation)

nhrp（吓一跳解析协议）
	next-hp resolution 
mgre，创建静态隧道和动态隧道

在布置为hub的设备上面配置
interface tunnel 0/0/0
ip address 配置tunnel的地址
source 因为作为hub的所以源的ip是固定
nhrp entry multicast dynamic 目的的ip动态获取动态组播
组里面
注意这里需要将tunnel的接口类型修改成
利用下一条动态获解析获取能力动态获取组播地址的谜底ip
在spoke的设备上面配置

配置举例
```huawei
基本配置和上面一样
r3
int g 0/0/0
ip address 1.1.1.3 24
int loopback 0 
ip address 10.1.3.3 32
---
r1，r2，r3在配置遂道上有区别
r1 
int tunnel 0/0/0
tunnel-protocol gre p2mp # 实际上应该mgre
	华三 int tunnel 0 mode mgre
	## 注意华三模拟器不提供hub端模拟 ##

ip address 172.16.1.1 24
# 这里把r1作为hub
source 1.1.1.1 这是固定hub端
mgre不支持destination 需要配置nhrp(next-hp route protocol)
nhrp entry multicast (这里是配置设置组播地址，用于构建组播遂道)

r2
ip address 172.16.1.2 24
source g 0/0/0 我和接口建立遂道
nhrp entry 172.1.1.1 (向哪个遂道建立遂道) 1.1.1.1 （目的遂道物理地址）

r3
ip address 172.16.1.3 24
source g 0/0/0 我和接口建立遂道
nhrp entry 172.1.1.1 (向哪个遂道建立遂道) 1.1.1.1 （目的遂道物理地址）

配置动态gre
分别在r1.r2.r3上面宣告隧道接口
省略配置流程.
但是会发现存在一个问题,那就是ospf智能建立一个邻居
这是因为在tunnel 接口下ospf会默认是p2p模式,修改ospf累心broadcast

ospf network-type broadcast 
但是仍然存在问题,因为我们配置的链路非全互联链路,导致传递的ldp信息不完全,导致部分路由缺失
需要手动修改dr优先级
ospf dr-priority 100

nhrp的重定向
这个功能存在的原因是存在一种情况,这里用ospf 来举例如果是p2mp的模式ospf下是r2,和r3分别建立了隧道,r2和r3没有隧道关系,这个时候r2和r3通讯,数据包会在r1处进行频繁的转发,可以在hub端口启用
nhrp redirect
在spoke端口上面
nhrp noshort
这样当r1收到r2目的是r3的nhrp request报文的时候r1会先退回,r2收到退回的nhrp会重新定位地址r3,这时候r1收道原r2后只传递不做其它处理。


```

